var ART=this,ART={};(function(){function hr(){_.get(window,"$Lan.code")!=="zh"&&_.extend(_.get(window,"$Lan.data"),{"还没上传贴图":"No pictures uploaded yet","文件格式不符合！允许的文件格式为":"File format not supported! The allowed file format is"})}function lr(n){switch(n){case 0:gt=1;rt=1;break;case 1:gt=1;rt=0;break;case 2:gt=0;rt=0}}function ar(n,t){gt=n;rt=t}function d(){w<h.length-1&&(h=h.slice(0,w+1));h.push(ai());h.length>30?h=h.slice(1):w++;it=0}function vr(){return h.length<=0||w>=h.length-1?!1:(it?it=0:w++,st(),!0)}function yr(){return h.length<=0||w<=0?!1:(it&&k=="table"?it=0:w--,st(),!0)}function st(){it&&(it=0);ir(h[w])}function pr(t){if(t){n=t;var i=_.cloneDeep(_.pick(n,["base","boxLayer","layers","selected"]));i.layersResx=n.layersResx;w<h.length-1&&(h=h.slice(0,w+1));h.push(i);h.length>30&&(h=h.slice(1))}}function wr(n,t){h=n;w=t}function ai(){return n?_.cloneDeep(_.pick(n,["base","boxLayer","layers","selected","layersResx"])):null}function ir(t){if(!_.isUndefined(t)){n.base=_.cloneDeep(t.base);n.layers=_.cloneDeep(t.layers);n.boxLayer=_.cloneDeep(t.boxLayer);n.selected=_.cloneDeep(t.selected);n.layersResx=t.layersResx;var r=_.concat([n.boxLayer],n.layers);i=_.filter(r,function(t){return _.findIndex(n.selected,function(n){return n==f(t)})>=0});tt.observeData()}}function br(i){t.toBeUpload=_.cloneDeep(_.pick(n,["base","boxLayer","layers","selected"]));i||(ti=1,w=0,h=[t.toBeUpload],st())}function kr(){_.extend(t.data,t.toBeUpload);w=0;h=[t.toBeUpload];st()}function dr(i,r){var h=li.noBoxStruct,o=ai(),s;if(!o)return alert("还没上传贴图！");var f=et.texture3D=et.texture3D||document.createElement("CANVAS"),l=e,c=o.base[2];b=1;a=di();v=a/25.4;s=ki();f.width=s[0];f.height=s[1];t.draw(f,h,i);ht(h,function(){for(var e,s=_.concat([n.boxLayer],n.layers),i=0;i<s.length;i++)e=s[i],e[1]*=c/u,e[2]*=c/u;yt(1);vi(o);t.draw(l,1);ht(0,function(){r&&r(f)})},0)}function gr(n,r,f){var s=ai(),c=e,h=s.base[2],o;if(!s)return alert("还没上传贴图！");o=et.thum=et.thum||document.createElement("CANVAS");b=r;a=di();v=a/25.4;o.width=n;o.height=n;t.draw(o,1,1);ht(0,function(){var n,r;for(lt(1),n=0;n<i.length;n++)r=i[n],r[1]*=h/u,r[2]*=h/u;yt(1);vi(s);t.draw(c,1);ht(0,function(){f&&f(o)})},0)}function vi(n){ir(n);b=n.base[1];a=n.base[0]}function nu(i,r,f){if(e){i=i||e.clientWidth;r=r||e.clientHeight;var o=u;b=f||b;e.width=i;e.height=r;t.draw(e,1);ht(0,function(){for(var i,r=_.concat([n.boxLayer],n.layers),t=0;t<r.length;t++)i=r[t],i[1]*=o/u,i[2]*=o/u;yt(1)})}}function tu(){t.draw(e,1);ht(0,function(){nt();t.stage.update()})}function iu(t,i,r,f,e){try{hr();b=.88;a=300;v=a/25.4;s=[i.Width*v,i.Height*v];c=[r,f];u=b*Math.min(c[0]/s[0],c[1]/s[1]);n={boxLayer:["BOX_"+i.BoxID,1,1,0,0,0,0,0,1],boxResx:{lines:t,boxJson:i},layers:[],layersResx:[],base:[a,b,u],selected:[],isFaceB:e||0};dt=0;h=[];w=-1}catch(o){}}function ru(t,i,f){if(_.isObject(e)&&ur(1),e=_.isString(t)?document.querySelector(t):t,e.getContext("2d"),c=[e.width,e.height],u=b*Math.min(c[0]/s[0],c[1]/s[1]),n.base=[a,b,u],r=new createjs.Stage(e),f){var o=new createjs.Shape;o.graphics.beginStroke("#fff").beginFill("#fff").drawRect(0,0,c[0],c[1]);o.name="background";r.addChild(o)}i||(bt(n.boxLayer),ct([n.boxLayer]),r.update());ur()}function uu(){var t=_.get(n,"boxResx.boxJson");t&&(s=[t.Width*v,t.Height*v],u=b*Math.min(c[0]/s[0],c[1]/s[1]))}function yi(t,i){var u,e,r;t&&t.children.length!=0&&(t.scaleX=i[1],t.scaleY=i[2],t.children[0].children[0].rotation=i[3],u=(1-t.scaleX)*c[0]/2,e=(1-t.scaleY)*c[1]/2,t.regX=-i[4]/t.scaleX-u/t.scaleX,t.regY=-i[5]/t.scaleY-e/t.scaleY,t.name==f(n.boxLayer)?gi(t.children[0].children[0].children[0].graphics):_.find(n.selected,function(n){return n==t.name})&&(r=t.children[0].getChildByName("mask"),r&&wi(r,i)))}function pi(){r.children&&_.each(r.children,function(n,t){var i,r,t;if(n.name!="background"&&n.children&&n.children.length>0&&(i=n.children[0].getChildByName("mask"),i))for(r=n.children[0].getChildIndex(i),i.visible=!1,t=r+1;t<=r+4;t++)n.children[0].children[t].visible=!1})}function wi(n,t){var c=v*u,e=t[1]*c,w=t[2]*c,a=8/e,i=50/e,r=-25/e,f=-25/w,o=n.regX*2,s=n.regY*2,y=ci||"red";n.graphics.clear();n.graphics.setStrokeStyle(a).beginStroke(y).rect(0,0,o,s).closePath();var b=[["lt",r,f],["lb",r,s+f],["rt",o+r,f],["rb",o+r,s+f]],p=n.parent,h=!0;l>0&&k=="table"&&(h=!1);_.each(b,function(r){var f="dot_"+r[0],e=r[1],o=r[2],u=p.getChildByName(f);u==null&&(u=new createjs.Shape,u.name=f,u.scale=n.scale,u.regX=n.regX,u.regY=n.regY,u.setBounds(e,o,i,i),p.addChild(u));u.graphics.clear();u.graphics.setStrokeStyle(a).beginFill(y).drawRect(e,o,i,i).endFill();u.rotation=t[3];u.visible=h});n.rotation=t[3];n.visible=h}function nt(n){pi();n=n||i;for(var t=0;t<n.length;t++)yi(r.getChildByName(f(n[t])),n[t]);l>0&&k=="table"||tt.observeData()}function ii(){var f,e,u,r;if(g&&i.length&&(f=1+(o[1]-p[1]),e=1+(o[2]-p[2]),i[0][0]!=n.boxLayer[0]||!(i[0][1]*f<tr[0]||i[0][1]*f>tr[1]))){for(u=0;u<i.length;u++)for(i[u][1]*=f,i[u][2]*=e,r=3;r<6;r++)switch(r){case 4:i[u][r]=(kt[u][r]+(o[r]-p[r]))*f;break;case 5:i[u][r]=(kt[u][r]+(o[r]-p[r]))*e;break;default:i[u][r]=kt[u][r]+(o[r]-p[r])}nt(i);t.stage.update()}}function bi(n,t){if(g&&i.length){if(t&&ut(1),!i.length)return t&&ut(0);fi();_.forEach(n,function(n,t){switch(t){case"1":case"2":o[t]+n>0&&n>-1&&(o[t]+=n);break;default:o[t]+=n}});ii()}}function f(n){return n[0]+"_"+n[8]}function fu(t){return _.includes(n.selected,f(t))}function eu(i){var u,r,e,o;for(fi(),u=0;u<n.layers.length;u++)r=n.layers[u],i?(e=r[1]/n.boxLayer[1],o=r[2]/n.boxLayer[2],r[4]=r[4]/n.boxLayer[1]-n.boxLayer[4]/n.boxLayer[1],r[5]=r[5]/n.boxLayer[2]-n.boxLayer[5]/n.boxLayer[2],r[1]=e,r[2]=o,r[3]=r[3]-n.boxLayer[3]):_.find(t.data.selected,function(n){return n==f(r)})&&(r[1]=n.boxLayer[1],r[2]=n.boxLayer[2],r[4]=n.boxLayer[4],r[5]=n.boxLayer[5]);i&&(n.boxLayer[1]=n.boxLayer[2]=1,n.boxLayer[3]=0,n.boxLayer[4]=n.boxLayer[5]=0)}function yt(i){if(eu(i),i){var r=_.concat([n.boxLayer],n.layers);nt(r)}else nt();t.stage.update()}function ut(t){t?nr=i:(i=nr,n.selected=_.transform(i,function(n,t){n.push(f(t))}))}function ki(){var n=t.maxSize;sc=1;var i=s[0]*sc,r=s[1]*sc,u=Math.max(i,r);return u<=n?[i,r]:[n*i/u,n*r/u]}function di(){var t=n.boxResx.boxJson,u=a,i,r;return a=300,v=a/25.4,s=[t.Width*v,t.Height*v],i=ki(),r=i[0]*25.4/t.Width,a=u,v=a/25.4,s=[t.Width*v,t.Height*v],r}function ht(t,i,u){(_.isUndefined(u)||u==null)&&(u=ot);i=i||Cm.EMPTY_FUN;var e=0,o=function(){e++;e==n.layers.length&&(t||(bt(n.boxLayer),nt([n.boxLayer])),i())},s=function(n){var t=new createjs.Container,i;r.addChild(t);t.name=f(n);i=ri(n[0]);i&&(ui({container:t,layerData:n,img:i,isDrawMask:u,needUpdate:0}),o())};_.forEach(n.layers,function(n){s(n)});n.layers.length||(t||bt(n.boxLayer),i())}function lt(t){selectType=t?"table":"pics";i=t?_.concat([n.boxLayer],n.layers):n.layers;n.selected=_.transform(i,function(n,t){n.push(f(t))})}function ct(t){if(t){var r=_.concat([n.boxLayer],n.layers),u=_.chain(r).intersectionBy(t,f).value();i=[];n.selected=[];_.forEach(u,function(t){i.push(t);n.selected.push(f(t))})}else i=[],n.selected=[]}function ou(t,r){var u=r||[],e;(_.isUndefined(t)&&t==null||_.each(t,function(t){n.layers[t]&&u.push(n.layers[t])}),u.length!=0)&&(e=_.difference(n.layers,u),n.layers=[],i=_.difference(i,u),_.each(e,function(t,r){var u=_.find(i,function(n){return n[0]==t[0]});u&&(u[8]=r);t[8]=r;n.layers.push(t)}),n.selected=_.transform(i,function(n,t){n.push(f(t))}),n.selected.length==0&&(n.selected=[]),i.length==0&&(i=[]),dt=n.layers.length,d())}function su(t,r){var u=_.find(n.layers,function(n){return n[8]==t}),e;r==0?u[8]=-1:t>r?u[8]=(r*2-1)/2:t<r&&(u[8]=(r*2+1)/2);e=_.cloneDeep(u[8]);n.selected=[f(u)];n.layers=_.sortBy(n.layers,function(n){return n[8]});_.each(n.layers,function(t,r){t[8]==e?(t[8]=r,n.selected=[f(t)],i=[t]):t[8]=r});d();st()}function hu(t,r){var e=i[0][0],u=_.find(n.layers,function(n){return n[8]==t});r==0?u[8]=-1:t>r?u[8]=(r*2-1)/2:t<r&&(u[8]=(r*2+1)/2);n.layers=_.sortBy(n.layers,function(n){return n[8]});_.each(n.layers,function(t,r){t[0]==e?(t[8]=r,n.selected=[f(t)],i=[t]):t[8]=r});d();st()}function cu(n){var t;return window.createObjectURL!=undefined?t=window.createObjectURL(n):window.URL!=undefined?t=window.URL.createObjectURL(n):window.webkitURL!=undefined&&(t=window.webkitURL.createObjectURL(n)),t}function lu(t,i){var u=function(){var e=this.files[0],o=cu(e),h=t[0]=e.name.toLowerCase(),a=h.lastIndexOf("."),s=h.substr(a+1),c,u,l;if(cr.indexOf(s.toLowerCase())==-1){alert("文件格式不符合！允许的文件格式为".exLang()+' ["jpg", "jpeg", "pdf", "png", "tif","tiff","gif"]');return}rt&&n.layers.length&&(c=r.getChildByName(f(n.layers[0])),n.layers=[],r.removeChild(c));n.layers.push(t);u=new createjs.Container;r.addChild(u);r.setChildIndex(r.children[r.children.length-1],r.children.length-2);pi();rt&&au(e);_.find(n.layersResx,function(n){return n.name==t[0]})&&(s=t[0].split(".")[1],l=(new Date).getTime(),t[0]=t[0].substring(0,t[0].length-4)+"_"+l+"."+s);_.endsWith(t[0],".pdf")?wu(t,o,function(n){u.name=f(t);ui({container:u,layerData:t,img:n,isDrawMask:ot});ct([t]);d();i&&i();tt.image_mousedown();tt.observeData()}):_.endsWith(t[0],".tif")||_.endsWith(t[0],".tiff")?bu(t,o,function(n){u.name=f(t);ui({container:u,layerData:t,img:n,isDrawMask:ot});ct([t]);d();i&&i();tt.image_mousedown();tt.observeData()}):pu({url:o,container:u,layerData:t,isDrawMask:ot},i)};pt=document.createElement("input");pt.addEventListener("change",u,!1);pt.type="file";pt.accept="image/*,application/pdf";pt.click()}function au(n){var i=this,t=new FileReader;t.readAsBinaryString(n);t.onload=function(){et.fileName=n.name;et.fileBinaryString=this.result}}function ri(n){var i=_.find(t.data.layersResx,function(t){return t.name==n}),r=_.get(i,"db");return r.$Canvas?_.get(i,"db.$Canvas"):r}function vu(i,r){function c(n){var i=_.find(t.data.layers,function(t){return t[8]==n}),r=ri(_.get(i,"0"));r&&(i[1]=Math.abs(Math.sin(Math.PI*i[3]/180))==1?i[2]=h/r.height*o:i[2]=h/r.width*o,i[4]=e[4],i[5]=e[5],u.push(i))}if(r=r||0,i=i||0,t.data.layers.length!==0){var u=[],e=t.data.boxLayer,o=t.data.boxLayer[1],h=ni*2*v+s[0];i==0?_.each(t.selected,function(t){f(t)!=f(n.boxLayer)&&c(t[8])}):c(i);u.push(n.boxLayer);t.select(u);r||t.render();d()}}function yu(i){function h(n){var i=_.find(t.data.layers,function(t){return t[8]==n}),f=ri(_.get(i,"0"));f&&(i[1]=Math.abs(Math.sin(Math.PI*i[3]/180))==1?i[2]=o/f.width*e:i[2]=o/f.height*e,i[4]=u[4],i[5]=u[5],r.push(i))}if(i=i||0,t.data.layers.length!==0){var r=[],u=t.data.boxLayer,e=t.data.boxLayer[1],o=ni*2*v+s[1];i==0?_.each(t.selected,function(t){f(t)!=f(n.boxLayer)&&h(t[8])}):h(i);r.push(n.boxLayer);t.select(r);t.render();d()}}function pu(t,i){var e=t.container,u=t.layerData,o=t.isDrawMask,r;e.name=f(u);r=new Image;r.src=t.url;r.onload=function(){n.layersResx.push({name:u[0],db:r});ui({container:e,layerData:u,img:r,isDrawMask:o});ct([u]);d();i&&i();tt.image_mousedown();tt.observeData()}}function wu(i,r,u){var f=i[0],e={url:r,cMapUrl:"https://unpkg.com/pdfjs-dist@2.0.943/cmaps/",cMapPacked:!0};pdfjsLib.getDocument(e).then(function(r){r.getPage(1).then(function(r){var s=document.createElement("CANVAS"),h,p,k;r.$Canvas=s;h={name:f,db:r,fixS:1};n.layersResx.push(h);var c=r.getViewport(1,1),l=300/72,a=300/72,v=1,w=1,e=v=c.width*l,o=w=c.height*a,d=t.maxSize,y=Math.pow(d,2),g=e*o,b=1;y<g&&(e=Math.sqrt(e*y/o),o=y/e,h.fixS=b=v/e,i[1]=i[2]=b,l*=e/v,a*=o/w);s.width=e;s.height=o;p=s.getContext("2d");k={transform:[l,0,0,a,0,0],canvasContext:p,viewport:c};r.render(k).promise.then(function(){u&&u(p.canvas)})})})}function ui(t){var v=t.container,e=t.layerData,y=t.isDrawMask,o=t.img,p=t.needUpdate||1,l=o.width,a=o.height,i=new createjs.Container,s,f,h;i.name="layer";v.addChild(i);s=new createjs.Bitmap(o);s.scale=u;i.addChild(s);s.regX=o.width/2;s.regY=o.height/2;i.regX=-s.regX*e[1]-(c[0]-o.width*e[1])/2;i.regY=-s.regY*e[1]-(c[1]-o.height*e[2])/2;y&&(f=new createjs.Shape,f.name="mouseMask",f.alpha=.2,i.addChild(f),h=new createjs.Shape,h.name="mask",h.scale=u,h.regX=l/2,h.regY=a/2,i.addChild(h),wi(h,e),i.handleOver=i.on("mouseover",function(){var n=i.children[0].rotation;f.graphics.clear();f.graphics.beginFill("grey").drawRect(-(l/2)*u,-(a/2)*u,l*u,a*u);f.rotation=n;r.update()}),i.handleOut=i.on("mouseout",function(){f.graphics.clear();r.update()}),f.handleDown=f.on("mousedown",function(t){(t.stopPropagation(),hi=="contain"&&n.selected.length>1)||(f.graphics.clear(),pi(),ct([e]),nt(),r.update())}));yi(v,e);p&&r.update()}function bu(t,i,r){var u=t[0];Cm.xmlReq2({url:i,responseType:"arraybuffer",success:function(t){var i,f,e;setTimeout(function(){Tiff.initialize({TOTAL_MEMORY:t.byteLength})},1e3);i=new window.Tiff({buffer:t});i&&(console.log("width:",i.width()),console.log("height:",i.height()),console.log("currentDirectory:",i.currentDirectory()),console.log("countDirectory:",i.countDirectory()),f=i.toCanvas(),f&&(e={name:u,db:f},n.layersResx.push(e),r&&r(f),i.close()))}})}function ku(){var n=navigator.userAgent,t=n.match(/(iPad).*OS\s([\d_]+)/),i=!t&&n.match(/(iPhone\sOS)\s([\d_]+)/),r=n.match(/(Android)\s+([\d.]+)/);return i||r}function bt(n){var h=new createjs.Container,o=new createjs.Container,e=new createjs.Container,a,i;wt=new createjs.Container;h.name=f(n);r.addChild(h);h.addChild(o);o.addChild(e);e.regX=s[0]*u/2;e.regY=s[1]*u/2;o.regX=-e.regX-(c[0]-s[0]*u)/2;o.regY=-e.regY-(c[1]-s[1]*u)/2;a=new createjs.Shape;e.addChild(a);e.addChild(wt);i=new createjs.Container;e.addChild(i);r.$Rect=i;i.mouseover_rect=i.on("mouseover",function(n){n.stopPropagation();var t=n.target,i=t.$Sign;i&&(y.alived=i.idx,t.alpha=.2,r.update())});i.mouseout_rect=i.on("mouseout",function(n){n.stopPropagation();var t=n.target,i=t.$Sign;i&&(y.selected!==i.idx&&(y.alived=-1,t.alpha=.01),r.update())});i.mousedown_rect=i.on("mousedown",function(n){n.stopPropagation();var i=n.target,t=function(){var n=i.$Sign;n&&(y.alived=n.idx,rr(y.alived))};Cm.isPC()?t():setTimeout(function(){l==0&&t()},180)});t.stage.enableMouseOver(_.invoke(window,"Cm.isPC")?60:10);gi(a.graphics)}function gi(i){function l(t){return n.isFaceB&&(t.x=ht*2-t.x),{x:t.x,y:t.y}}function ct(t){return n.isFaceB&&(t=t<=1?1-t:3-t),t}function bt(){for(var p,w,s,r,u,c,a,f=0,v=nt.length;f<v;f++){var b=nt[f][0],y=nt[f][1],t=nt[f].slice(2),k=y?vt:at;i.beginStroke(k).setStrokeStyle(pt);y?i.setStrokeDash([4/n.boxLayer[1],2/n.boxLayer[1]],0):i.setStrokeDash([3e3,0],0);switch(b){case 0:r={x:(t[0]-o)*e,y:(t[1]-h)*e};u={x:(t[2]-o)*e,y:(t[3]-h)*e};r=l(r);u=l(u);i.moveTo(r.x,r.y);i.lineTo(u.x,u.y);break;case 1:r={x:(t[0]-o)*e,y:(t[1]-h)*e};r=l(r);p=-t[4];w=-t[3];i.arc(r.x,r.y,t[2]*e,Math.PI*ct(p/180),Math.PI*ct(w/180),ut);break;case 2:for(r={x:(t[0]-o)*e,y:(t[1]-h)*e},r=l(r),i.moveTo(r.x,r.y),s=1;s<t.length/2;s++)u={x:(t[s*2]-o)*e,y:(t[s*2+1]-h)*e},u=l(u),i.lineTo(u.x,u.y);break;case 3:r={x:(t[0]-o)*e,y:(t[1]-h)*e};r=l(r);u={x:(t[2]-o)*e,y:(t[3]-h)*e};u=l(u);c={x:(t[4]-o)*e,y:(t[5]-h)*e};c=l(c);a={x:(t[6]-o)*e,y:(t[7]-h)*e};a=l(a);i.moveTo(r.x,r.y);i.bezierCurveTo(u.x,u.y,c.x,c.y,a.x,a.y);break;default:continue}}}function gt(){var r=t.maxSize,n=t.boxSize[0]/r,i=t.boxSize[1]/r;return n<1&&i<1?n>i?i:n:1}var et=r.getChildByName(f(n.boxLayer)),b,rt,ut,ht,wt,k,it,a;if(et){b=et.children[0];i||(uu(),rt=b.children[0],b.regX=s[0]*u/2,b.regY=s[1]*u/2,rt.regX=-b.regX-(c[0]-s[0]*u)/2,rt.regY=-b.regY-(c[1]-s[1]*u)/2);i=i||b.children[0].children[0].graphics;at=at||"#666";vt=vt||"#666";var ot=n.boxLayer[1],pt=1/n.boxLayer[1],nt=n.boxResx.lines,st=n.boxResx.boxJson,o=st.OffsetX,h=st.OffsetY,e=v*u;i.clear();ut=!1;n.isFaceB&&(ut=!0);ht=s[0]*u/2;wt=s[1]*u/2;bt();var b=r.getChildByName(f(n.boxLayer)).children[0].children[0],lt=b.children[1],yt=b.children[2];if(lt.children=[],yt.children=[],y.data.length){k=(y.fontSize/n.boxLayer[1]).toFixed(3);ku()&&(k=k>1?k:.5);var kt=k+"px Arial",tt=y.colors,dt=y.data,d=Math.sin,g=Math.cos;var ni=gt(),w=3*e/n.boxLayer[1]*ni,p=function(n,t,r,u){var e,o,s;r=r||0;u=u||0;var a=r+90,v=r+-90,y=r+90+60,p=r+-90-60,b=r+180;a*=Math.PI/180;v*=Math.PI/180;y*=Math.PI/180;p*=Math.PI/180;b*=Math.PI/180;e={x:n+w*g(a),y:t-w*d(a)};o={x:n+w*g(v),y:t-w*d(v)};e=l(e);o=l(o);i.moveTo(e.x,e.y);i.lineTo(o.x,o.y);var h={x:n+w*g(y),y:t-w*d(y)},f={x:n,y:t},c={x:n+w*g(p),y:t-w*d(p)};h=l(h);f=l(f);c=l(c);i.moveTo(h.x,h.y);i.lineTo(f.x,f.y);i.lineTo(c.x,c.y);u&&(s={x:n+u*w*g(b),y:t-u*w*d(b)},s=l(s),i.moveTo(s.x,s.y),i.lineTo(f.x,f.y))};ft=ft||document.createElement("CANVAS");it=ft.getContext("2d");a=n.boxLayer[1]>1?n.boxLayer[1]:1;_.forEach(dt,function(t,r){var u,v,c,w,d,b,nt,f,s,rt,ut,ft;if(i.beginStroke(tt[t[6]]).setStrokeStyle(.6/n.boxLayer[1]),u=new createjs.Text(t[4],kt,tt[t[6]]),u.textAlign="center",u.textBaseline="middle",u.$Sign={idx:r,data:t},lt.addChild(u),v={"1":5,"2":-5,"3":0}[t[5]]/e/a,_.startsWith(t[2],"x")&&(u.x=(t[0]+t[3]/2-o)*e,u.y=(t[1]-h)*e,u.y+=t[2]!="xb"?-(.5*k+4)/a:(.5*k+4)/a,t[3]*a>=10?(f={x:(t[0]-o+v)*e,y:(t[1]-h)*e},f=l(f),s={x:(t[0]+t[3]-o-v)*e,y:(t[1]-h)*e},s=l(s),i.moveTo(f.x,f.y),i.lineTo(s.x,s.y),p((t[0]-o+v)*e,(t[1]-h)*e,180),p((t[0]+t[3]-o-v)*e,(t[1]-h)*e)):(p((t[0]-o+v)*e,(t[1]-h)*e,0,4),p((t[0]+t[3]-o-v)*e,(t[1]-h)*e,180,4))),_.startsWith(t[2],"y")&&(u.x=(t[0]-o)*e,u.y=(t[1]+t[3]/2-h)*e,nt=(it.measureText(u.text).width+24)*.5/a,u.x+=t[2]!="yl"?nt:-nt,t[3]*a>=10?(f={x:(t[0]-o)*e,y:(t[1]-h+v)*e},f=l(f),s={x:(t[0]-o)*e,y:(t[1]+t[3]-h-v)*e},s=l(s),i.moveTo(f.x,f.y),i.lineTo(s.x,s.y),p((t[0]-o)*e,(t[1]-h+v)*e,90),p((t[0]-o)*e,(t[1]+t[3]-h-v)*e,-90)):(p((t[0]-o)*e,(t[1]-h+v)*e,-90,4),p((t[0]-o)*e,(t[1]+t[3]-h-v)*e,90,4))),_.startsWith(t[2],"r")){var ti=_.toNumber(t[2].substr(1)),et=t[3]*1.414/2,st=t[3]*1.414/2+20/a,ht=(it.measureText(u.text).width+20)/a,f={x:(t[0]-o)*e,y:(t[1]-h)*e},s={x:(t[0]-o+(t[2]=="r1"||t[2]=="r4"?st:-st))*e,y:(t[1]-h+(t[2]=="r1"||t[2]=="r2"?-st:st))*e},pt=(t[0]-o+(t[2]=="r1"||t[2]=="r4"?et:-et))*e,ii=(t[1]-h+(t[2]=="r1"||t[2]=="r2"?-et:et))*e,wt=10/a;(t[2]=="r2"||t[2]=="r3")&&(wt=-10/a);var bt=(s.y-f.y)/(s.x-f.x),gt=f.y-f.x*bt,ni=pt-wt,ri=bt*ni+gt,ct=pt+wt,dt=bt*ct+gt,ui=ct+(t[2]=="r1"||t[2]=="r4"?ht:-ht),fi=dt;i.moveTo(ni,ri);i.lineTo(ct,dt);i.lineTo(ui,fi);p(pt,ii,45+90*(ti-1),0);u.x=ct+(t[2]=="r1"||t[2]=="r4"?ht*.5:-ht*.5);u.y=dt;u.y+=-.5*k/a}_.startsWith(t[2],"a")&&(c=_.toNumber(t[2].substr(1)),w=c+t[3],_.startsWith(t[2],"ac")&&(w=_.toNumber(t[2].substr(2)),c=w-t[3]),c*=Math.PI/180,w*=Math.PI/180,d=20/a,b=20/a,u.x=(t[0]-o+b*Math.cos(c))*e,u.y=(t[1]-h-b*Math.sin(c))*e,nt=it.measureText(u.text).width/a,u.x+=nt*Math.cos(c),u.y+=-k/a*Math.sin(c),f={x:(t[0]-o+d*Math.cos(c))*e,y:(t[1]-h-d*Math.sin(c))*e},s={x:(t[0]-o+b*Math.cos(c))*e,y:(t[1]-h-b*Math.sin(c))*e},f=l(f),s=l(s),i.moveTo(f.x,f.y),i.lineTo(s.x,s.y),rt={x:(t[0]-o+d*Math.cos(w))*e,y:(t[1]-h-d*Math.sin(w))*e},ut={x:(t[0]-o+b*Math.cos(w))*e,y:(t[1]-h-b*Math.sin(w))*e},rt=l(rt),ut=l(ut),i.moveTo(rt.x,rt.y),i.lineTo(ut.x,ut.y),p((t[0]-o+.5*(d+b)*Math.cos(c))*e,(t[1]-h-.5*(d+b)*Math.sin(c))*e,c*180/Math.PI+90,2),p((t[0]-o+.5*(d+b)*Math.cos(w))*e,(t[1]-h-.5*(d+b)*Math.sin(w))*e,w*180/Math.PI-90,2));n.isFaceB&&(ft={x:u.x,y:u.y},ft=l(ft),u.x=ft.x,u.y=ft.y);y.selected==u.$Sign.idx&&(u.color=tt[2]);var at=u.getMeasuredWidth()+15/ot,vt=u.getMeasuredHeight()+15/ot,g=new createjs.Shape;u.$Rect=g;yt.addChild(g);g.alpha=.01;g.graphics.beginFill(tt[t[6]]).drawRect(u.x-at/2,u.y-vt/2,at,vt);g.setBounds(u.x-at/2,u.y-vt/2,at,vt);g.$Sign=u.$Sign})}}}function rr(n){var i,u,t;wt&&(i=y.colors,y.selected>-1&&(u=_.get(y,"data["+y.selected+"]"),u&&(t=wt.children[y.selected],t.color=i[u[6]],t.$Rect.alpha=.01)),y.selected=n,t=wt.children[n],t&&(window.$Txt=t,t.color=i[2],t.$Rect.alpha=.2),r.update(),tt.sign_mousedown(n))}function ur(n){var i=_.bind(n?e.removeEventListener:e.addEventListener,e),t;i("contextmenu",du,!1);i("mousedown",gu,!1);i("mousewheel",or,{passive:!0});i("DOMMouseScroll",or,{passive:!0});i("touchstart",nf,{passive:!0});i("touchend",rf,{passive:!0});i("touchmove",tf,{passive:!0});n&&r&&(t=r.$Rect,t&&(t.off("mouseover",t.mouseover_rect),t.off("mouseout",t.mouseout_rect),t.off("mousedown",t.mousedown_rect)),$.each(r.children,function(n,t){!_.isUndefined(t.children)&&t.children.length>0&&(t.children[0].off("mouseover",t.children[0].handleOver),t.children[0].off("mouseout",t.children[0].handleOut),!_.isUndefined(t.children[0].children)&&t.children[0].children.length>1&&t.children[0].children[1].off("mousedown",t.children[0].children[1].handleDown))}));createjs.Touch.enable(r)}function fi(){return i.length?kt=_.cloneDeep(i):null,p=_.cloneDeep(i[0]),o=_.cloneDeep(i[0])}function du(n){n.preventDefault()}function gu(n){if(g){k=="table"&&(ut(1),lt(1));l=1;fi();var t=n.clientX-e.clientLeft,i=n.clientY-e.clientTop;p[4]=o[4]=t;p[5]=o[5]=i;e.addEventListener("mousemove",fr,!1);e.addEventListener("mouseup",er,!1)}}function fr(n){var t=n.clientX-e.clientLeft,r=n.clientY-e.clientTop;if(g&&i.length)return l==1?(o[4]=t,o[5]=r,ii(1)):void 0}function er(){g&&l!=0&&(l==1&&k=="table"&&(l=0,ut(0),nt(),t.stage.update(),it=1),l=0,e.removeEventListener("mousemove",fr),e.removeEventListener("mouseup",er),k=="all"&&d())}function or(r){if(g){l=3;var u=0;r.wheelDelta?u=r.wheelDelta/1e4:r.detail&&(u=-r.detail/1e3);u*=oi;rt&&i.length!=_.concat([n.boxLayer],n.layers).length||u&&(k=="all"?(bi({"1":u,"2":u}),d()):(ut(1),lt(1),bi({"1":u,"2":u}),l=0,ut(0),nt(),t.stage.update(),it=1),l=0)}}function nf(n){if(g){k=="table"&&(ut(1),lt(1));fi();switch(n.touches.length){case 1:l=1;p[4]=o[4]=n.touches[0].pageX;p[5]=o[5]=n.touches[0].pageY;break;case 2:l=2;var t=n.touches[0].pageX-n.touches[1].pageX,i=n.touches[0].pageY-n.touches[1].pageY;p[1]=o[1]=p[2]=o[2]=Math.sqrt(t*t+i*i)/200}}}function tf(t){if(g)switch(t.touches.length){case 1:if(l!=1)return;o[4]=t.touches[0].pageX;o[5]=t.touches[0].pageY;ii();break;case 2:if(l!=2)return;if(!rt||i.length==_.concat([n.boxLayer],n.layers).length){var r=t.touches[0].pageX-t.touches[1].pageX,u=t.touches[0].pageY-t.touches[1].pageY;o[1]=o[2]=Math.sqrt(r*r+u*u)/200;kt=_.cloneDeep(i);ii();p[1]=o[1];p[2]=o[2]}}}function rf(n){if(g){l>0&&k=="table"&&(l=0,ut(0),nt(),t.stage.update(),it=1);l=0;switch(n.touches.length){case 1:if(l!=1)return;p[4]=o[4]=p[5]=o[5]=0;break;case 2:if(l!=2)return;p[1]=o[1]=p[2]=o[2]=0}k=="all"&&d()}}function uf(n,i){var f=_.get(window,"ART"),u=_.get(window,"D3"),r;if(f&&u){i=i||"#fff";n=n||"ka";r=ft=ft||document.createElement("CANVAS");switch(n){case"ka":t.refreshOutputCanvas(0,function(n){r.width=n.width;r.height=n.height;var f=r.getContext("2d");t.drawColorBg({ctx:f,bgColor:i,alpha:1});u.changeImageB(r,1,function(){f.drawImage(n,0,0,n.width,n.height);u.changeImageA(r,1)})});break;default:t.refreshOutputCanvas(0,function(i){r.width=i.width;r.height=i.height;var f=r.getContext("2d");t.drawImageBg({ctx:f,paper:n,face:"A"}).then(function(){f.drawImage(i,0,0,i.width,i.height);u.changeImageA(r,1,function(){t.drawImageBg({ctx:f,paper:n,face:"B"}).then(function(){u.changeImageB(r,1)})})})})}}}function ff(n){var t=n.ctx,i=t.canvas,r;(t.clearRect(0,0,i.width,i.height),n.alpha<=0||!n.bgColor)||(r=t.globalAlpha,t.globalAlpha=n.alpha,t.fillStyle=n.bgColor,t.fillRect(0,0,i.width,i.height),t.globalAlpha=r)}function sr(n,t,i,r,u,f,e){var o=n.canvas,c=o.width/u|0,l=o.height/f|0,s,h,v,y,a;for(n.save(),e&&(u^=f,f=u^f,u=u^f,c=o.height/u|0,l=o.width/f|0,n.setTransform(0,1,-1,0,n.canvas.width,0)),s=Math.ceil(u),h=Math.ceil(f),s+=s%2==0?1:0,h+=h%2==0?1:0,n.clearRect(0,0,o.width,o.height),v=i=="right"?-(s-u)*c:i=="center"?-(s*c-o.width)*.5:0,y=r=="bottom"?-(h-f)*l:r=="middle"?-(h*l-o.height)*.5:0,a=0;a<s;a++)for(j=0;j<h;j++)n.drawImage(t,a*c+v,j*l+y,c,l);n.restore()}function ef(n){return new Promise(function(i){var r=n.ctx.canvas,o=_.get(t,"data.boxResx.boxJson.Width")||r.width,s=_.get(t,"data.boxResx.boxJson.Height")||r.height,h=Math.max(o,s),f,e,u;(sx=10*o/h,sy=10*s/h,sx<=0||sy<=0)||(f=n.image,e=n.face=="B"&&n.paper.toLowerCase()=="wa"?si:0,f?(sr(n.ctx,f,n.align,n.valign,sx,sy,e),i(r)):(u=document.createElement("IMG"),u.src="/Images/Cad/Paper/"+n.paper+"_"+n.face+".jpg",u.onload=function(){sr(n.ctx,u,n.align,n.valign,sx,sy,e);i(r)}))})}function of(n,t){var r=n.color||"#fff",u=n.paper||"ka",f=n.isFaceB?"B":"A",i;switch(u){case"ka":t&&t({color:r});break;default:i=document.createElement("IMG");i.src="/Images/Cad/Paper/"+n.paper+"_"+f+".jpg";i.onload=function(){t&&t({image:i})}}}function sf(n){var s=n.container,e=n.layerData,h=n.isDrawMask,t=n.img,l=t.width,a=t.height,i=new createjs.Container,r,o,f;i.name="layer";s.addChild(i);r=new createjs.Bitmap(t);r.scale=u;i.addChild(r);r.regX=t.width/2;r.regY=t.height/2;i.regX=-r.regX*e[1]-(c[0]-t.width*e[1])/2;i.regY=-r.regY*e[1]-(c[1]-t.height*e[2])/2;h&&(o=new createjs.Shape,o.name="mouseMask",o.alpha=.2,i.addChild(o),f=new createjs.Shape,f.name="mask",f.scale=u,f.regX=l/2,f.regY=a/2,i.addChild(f),wi(f,e));yi(s,e)}function hf(t,i){if(i!=null&&t!=null){vi(i);n.boxResx=i.boxResx;n.isFaceB=i.isFaceB;b=1;a=di();v=a/25.4;var r=ki();t.width=r[0];t.height=r[1]}}function cf(n,i,r){var f,e;if(n!=null&&(f=_.get(window,"ART"),e=_.get(window,"D3"),f&&e)){var s=i.color||"#fff",o=i.paper||"ka",u=n.getContext("2d"),l=u.canvas,h=i.isFaceB?"B":"A",c=i.image;switch(o){case"ka":t.drawColorBg({ctx:u,bgColor:s,alpha:1});r&&r();break;default:t.drawImageBg({ctx:u,paper:o,face:h,image:c}).then(function(){r&&r()})}}}function lf(t,i,e,o){(_.isUndefined(o)||o==null)&&(o=ot);e=e||Cm.EMPTY_FUN;var s=0,h=function(){s++;s==n.layers.length&&(t||(bt(n.boxLayer),nt([n.boxLayer])),e())},c=function(n){var t=new createjs.Container,e;r.addChild(t);t.name=f(n);e=ri(n[0]);e&&(i&&(n[1]*=i/u,n[2]*=i/u),sf({container:t,layerData:n,img:e,isDrawMask:o}),h())};_.forEach(n.layers,function(n){c(n)});n.layers.length||(t||bt(n.boxLayer),e())}function af(t,i,r){if(n.layers.length==0){r&&r();return}lf(1,i,function(){var f=t.width;n.boxLayer[1]*=i/u;n.boxLayer[2]*=i/u;yt(1);r&&r()},0)}function vf(t){var s=_.concat([n.boxLayer],n.layers),o=_.filter(s,function(t){return _.findIndex(n.selected,function(n){return n==f(t)})>=0}),r,e;for(lt(1),r=0;r<i.length;r++)e=i[r],e[1]*=t/u,e[2]*=t/u;o.length>0&&ct(o)}var t=ART,w,h,ti,ft,pt,wt,tt,g,l,kt,p,o;String.prototype.exLang=_.get(window,"Cm.exLang")||function(){};var r=null,e=null,a=300,yf=Math.PI/180,v=a/25.4,b=.88,c,u,n,i=[],s,nr=[],ei=null,dt=0,gt=0,rt=0,et={fileBinaryString:"",fileName:"",thum:null,texture3D:null},tr=[.05,100],ni=3,oi=1,si=0,hi="contain",ot=1,ci="red",k="all",it=0,y={choose:1,fontSize:12,colors:["#de7a00","#1f801f","#c800c8","#c8c800"],data:[],selected:-1,alived:-1},at="#666",vt="#666",cr=["jpg","jpeg","pdf","png","tif","tiff","gif"],li={noBoxStruct:1};w=-1;h=[];ti=0;ft=null;tt={sign_mousedown:Cm.EMPTY_FUN,image_mousedown:Cm.EMPTY_FUN,observeData:Cm.EMPTY_FUN};g=1;l=0;Cm.createGetterSetter(t,"init",function(){return iu});Cm.createGetterSetter(t,"changeMode",function(){return lr});Cm.createGetterSetter(t,"changeFileMode",function(){return ar});Cm.createGetterSetter(t,"changeSize",function(){return nu});Cm.createGetterSetter(t,"draw",function(){return ru});Cm.createGetterSetter(t,"addRecord",function(){return d});Cm.createGetterSetter(t,"goBack",function(){return yr});Cm.createGetterSetter(t,"reDo",function(){return vr});Cm.createGetterSetter(t,"goHistory",function(){return st});Cm.createGetterSetter(t,"doInput",function(){return lu});Cm.createGetterSetter(t,"stage",function(){return r});Cm.createGetterSetter(t,"dpi",function(){return a},function(n){a=n});Cm.createGetterSetter(t,"zoom",function(){return b},function(n){b=n});Cm.createGetterSetter(t,"scale",function(){return u},function(n){u=n});Cm.createGetterSetter(t,"selectAll",function(){return lt});Cm.createGetterSetter(t,"selected",function(){return i},function(n){i=n});Cm.createGetterSetter(t,"select",function(){return ct});Cm.createGetterSetter(t,"data",function(){return n},function(t){n=t});Cm.createGetterSetter(t,"outData",function(){return et});Cm.createGetterSetter(t,"reset",function(){return yt});Cm.createGetterSetter(t,"outputThumbnail",function(){return gr});Cm.createGetterSetter(t,"setDelta",function(){return bi});Cm.createGetterSetter(t,"refreshOutputCanvas",function(){return dr});Cm.createGetterSetter(t,"genUpdate",function(){return br});Cm.createGetterSetter(t,"fromUploadData",function(){return kr});Cm.createGetterSetter(t,"enabled",function(){return g},function(n){g=n});Cm.createGetterSetter(t,"hasNewUpdate",function(){return ti},function(n){ti=n});Cm.createGetterSetter(t,"idxLayers",function(){return dt},function(n){dt=n});Cm.createGetterSetter(t,"maxSize",function(){return ei?ei:ei=Cm.getMaxRenderSize()});Cm.createGetterSetter(t,"outputOption",function(){return li},function(n){li=n});Cm.createGetterSetter(t,"Bleeding",function(){return ni},function(n){ni=n});Cm.createGetterSetter(t,"isAgainstGrain",function(){return si},function(n){si=n});Cm.createGetterSetter(t,"scaleRate",function(){return oi},function(n){oi=n});Cm.createGetterSetter(t,"records",function(){return h});Cm.createGetterSetter(t,"curRecordIdx",function(){return w});Cm.createGetterSetter(t,"includeSelected",function(){return fu});Cm.createGetterSetter(t,"delLayer",function(){return ou});Cm.createGetterSetter(t,"sortLayer",function(){return su});Cm.createGetterSetter(t,"reorderLayer",function(){return hu});Cm.createGetterSetter(t,"render",function(){return function(){nt();r.update()}});Cm.createGetterSetter(t,"fitBoxWidth",function(){return vu});Cm.createGetterSetter(t,"fitBoxHeight",function(){return yu});Cm.createGetterSetter(t,"addFirstLayer",function(){return addFirstLayer});Cm.createGetterSetter(t,"sign",function(){return y},function(n){y=n});Cm.createGetterSetter(t,"refreshStructure",function(){return function(){gi();r.update()}});Cm.createGetterSetter(t,"refreshStage",function(){return function(){ht()}});Cm.createGetterSetter(t,"colorSolid",function(){return at},function(n){at=n});Cm.createGetterSetter(t,"colorDash",function(){return vt},function(n){vt=n});Cm.createGetterSetter(t,"changeSignSelected",function(){return rr});Cm.createGetterSetter(t,"on",function(){return function(n,t){tt[n]=t}});Cm.createGetterSetter(t,"canvas",function(){return e});Cm.createGetterSetter(t,"drawStage",function(){return function(){tu()}});Cm.createGetterSetter(t,"boxSize",function(){return s});Cm.createGetterSetter(t,"selectMode",function(){return hi},function(n){hi=n});Cm.createGetterSetter(t,"drawMask",function(){return ot},function(n){ot=n});Cm.createGetterSetter(t,"maskClor",function(){return ci},function(n){ci=n});Cm.createGetterSetter(t,"drawColorBg",function(){return ff});Cm.createGetterSetter(t,"drawImageBg",function(){return ef});Cm.createGetterSetter(t,"changeD3Paper",function(){return uf});Cm.createGetterSetter(t,"mouseMode",function(){return k},function(n){k=n});Cm.createGetterSetter(t,"addCahceRecord",function(){return pr});Cm.createGetterSetter(t,"setRecords",function(){return wr});Cm.createGetterSetter(t,"setMatSize",function(){return hf});Cm.createGetterSetter(t,"drawMatBackground",function(){return cf});Cm.createGetterSetter(t,"drawArtData",function(){return af});Cm.createGetterSetter(t,"refresh2DCvs",function(){return refresh2DCvs});Cm.createGetterSetter(t,"changeScale",function(){return vf});Cm.createGetterSetter(t,"loadImageBg",function(){return of})})();