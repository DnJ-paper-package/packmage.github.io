THREE.TrackballControls=function(n,t,i){function ut(n,t,i){var r=n.distanceTo(t)+i;n.sub(t).normalize();n.multiplyScalar(r).add(t)}function ft(n){r.enabled!==!1&&(n.preventDefault(),n.stopPropagation(),f===u.NONE&&(f=n.button),f!==u.ROTATE||r.noRotate?f!==u.ZOOM||r.noZoom?f!==u.PAN||r.noPan||(h=o=r.getMouseOnScreen(n.clientX,n.clientY)):l=y=r.getMouseOnScreen(n.clientX,n.clientY):c=s=r.getMouseProjectionOnBall(n.clientX,n.clientY),r.domElement.addEventListener("mousemove",nt,!1),r.addEventListener("mouseup",d,!1))}function nt(n){r.enabled!==!1&&(n.preventDefault(),n.stopPropagation(),f!==u.ROTATE||r.noRotate?f!==u.ZOOM||r.noZoom?f!==u.PAN||r.noPan||(o=r.getMouseOnScreen(n.clientX,n.clientY)):y=r.getMouseOnScreen(n.clientX,n.clientY):s=r.getMouseProjectionOnBall(n.clientX,n.clientY))}function d(n){r.enabled!==!1&&(n.preventDefault(),n.stopPropagation(),f=u.NONE,r.domElement.removeEventListener("mousemove",nt),r.removeEventListener("mouseup",d))}function it(n){if(r.enabled!==!1){n.preventDefault();n.stopPropagation();var t=0;n.wheelDelta?t=n.wheelDelta/40:n.detail&&(t=-n.detail/3);l.y+=t*.01}}function et(n){if(r.enabled!==!1)switch(n.touches.length){case 1:f=u.TOUCH_ROTATE;c=s=r.getMouseProjectionOnBall(n.touches[0].pageX,n.touches[0].pageY);break;case 2:f=u.TOUCH_ZOOM;var t=n.touches[0].pageX-n.touches[1].pageX,i=n.touches[0].pageY-n.touches[1].pageY;p=b=Math.sqrt(t*t+i*i);h=o=r.getMouseOnScreen(n.touches[0].pageX,n.touches[0].pageY);break;case 3:f=u.TOUCH_PAN;h=o=r.getMouseOnScreen(n.touches[0].pageX,n.touches[0].pageY);break;default:f=u.NONE}}function ot(n){if(r.enabled!==!1){n.preventDefault();n.stopPropagation();switch(n.touches.length){case 1:s=r.getMouseProjectionOnBall(n.touches[0].pageX,n.touches[0].pageY);break;case 2:var t=n.touches[0].pageX-n.touches[1].pageX,i=n.touches[0].pageY-n.touches[1].pageY;p=Math.sqrt(t*t+i*i);o=r.getMouseOnScreen(n.touches[0].pageX,n.touches[0].pageY);break;case 3:o=r.getMouseOnScreen(n.touches[0].pageX,n.touches[0].pageY);break;default:f=u.NONE}}}function st(n){if(r.enabled!==!1){switch(n.touches.length){case 1:c=s=r.getMouseProjectionOnBall(n.touches[0].pageX,n.touches[0].pageY);break;case 2:b=p=0;h=o=r.getMouseOnScreen(n.touches[0].pageX,n.touches[0].pageY);break;case 3:h=o=r.getMouseOnScreen(n.touches[0].pageX,n.touches[0].pageY)}f=u.NONE}}var r,u,rt,w,k,g;this.lights=i||[];r=this;u={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM:4,TOUCH_PAN:5};this.object=n;this.domElement=t!==undefined?t:document;this.enabled=!0;this.screen={width:0,height:0,offsetLeft:0,offsetTop:0};this.radius=(this.screen.width+this.screen.height)/4;this.rotateSpeed=1;this.zoomSpeed=1.2;this.panSpeed=1;this.autoRotate=!1;this.autoRotateAxis="y";this.isControls=!0;rt=Date.now();this.noRotate=!1;this.noZoom=!1;this.noPan=!1;this.staticMoving=1;this.dynamicDampingFactor=.2;this.minDistance=0;this.maxDistance=Infinity;this.keys=[65,83,68];this.target=new THREE.Vector3;var a=new THREE.Vector3,f=u.NONE,v=u.NONE,e=new THREE.Vector3,c=new THREE.Vector3,s=new THREE.Vector3,l=new THREE.Vector2,y=new THREE.Vector2,b=0,p=0,h=new THREE.Vector2,o=new THREE.Vector2;this.target0=this.target.clone();this.position0=this.object.position.clone();this.up0=this.object.up.clone();w={type:"change"};this.handleResize=function(){this.screen.width=window.innerWidth;this.screen.height=window.innerHeight;this.screen.offsetLeft=0;this.screen.offsetTop=0;this.radius=(this.screen.width+this.screen.height)/4};this.handleEvent=function(n){typeof this[n.type]=="function"&&this[n.type](n)};this.getMouseOnScreen=function(n,t){return new THREE.Vector2((n-r.screen.offsetLeft)/r.radius*.5,(t-r.screen.offsetTop)/r.radius*.5)};this.getMouseProjectionOnBall=function(n,t){var i=new THREE.Vector3((n-r.screen.width*.5-r.screen.offsetLeft)/r.radius,(r.screen.height*.5+r.screen.offsetTop-t)/r.radius,0),f=i.length(),u;return f>1?i.normalize():i.z=Math.sqrt(1-f*f),e.copy(r.object.position).sub(r.target),u=r.object.up.clone().setLength(i.y),u.add(r.object.up.clone().cross(e).setLength(i.x)),u.add(e.setLength(i.z)),u};this.rotateCamera=function(){var n=Math.acos(c.dot(s)/c.length()/s.length()),i,t;if(n){for(i=(new THREE.Vector3).crossVectors(c,s).normalize(),quaternion=new THREE.Quaternion,n*=r.rotateSpeed,quaternion.setFromAxisAngle(i,-n),e.applyQuaternion(quaternion),r.object.up.applyQuaternion(quaternion),t=0;t<r.lights.length;t++)r.lights[t].position.applyQuaternion(quaternion);s.applyQuaternion(quaternion);r.staticMoving?c.copy(s):(quaternion.setFromAxisAngle(i,n*(r.dynamicDampingFactor-1)),c.applyQuaternion(quaternion))}};this.toggleAutoRotate=function(){arguments.length?this.autoRotate=arguments[0]:r.autoRotate=!r.autoRotate;r.autoRotate?this.autoRotateOn():this.autoRotateOff()};this.setAutoRotateAxis=function(n){n&&(r.autoRotateAxis=n)};this.autoRotateOn=function(n){r.time=Date.now();r.setAutoRotateAxis(n);r.autoRotate=!0};this.autoRotateOff=function(){r.autoRotate=!1};this.setPosBySpherical=function(n){r.object.position.setFromSpherical(n);controls.object.lookAt(controls.target)};this.genParametricGeometry=function(n){n=_.extend({fx:"cos(u) * sin(v)",fy:"sin(u) * cos(v) + cos(v)",fz:"u * 6",rangeU:[0,Math.PI*.5],rangeV:[0,Math.PI*2],slices:4,stacks:40},n);var t=Parser.parse(n.fx).toJSFunction(["u","v"]),i=Parser.parse(n.fy).toJSFunction(["u","v"]),r=Parser.parse(n.fz).toJSFunction(["u","v"]),u=function(u,f,e){u=THREE.Math.mapLinear(u,0,1,n.rangeU[0],n.rangeU[1]);f=THREE.Math.mapLinear(f,0,1,n.rangeV[0],n.rangeV[1]);var o=t(u,f),s=i(u,f),h=r(u,f);isNaN(o)||isNaN(s)||isNaN(h)?e.set(0,0,0):e.set(o,s,h)};return new THREE.ParametricGeometry(u,n.slices,n.stacks)};this.addParametricModel=function(){var t;window.me&&D3.scene.remove(t);var v=(new THREE.TextureLoader).load("https://packmage.blob.core.chinacloudapi.cn/cad/works/537528cf-7dd5-4251-a480-1e2067646415/2019081321434161708604.jpg"),o=new THREE.MeshStandardMaterial({side:2,color:"#FFF",map:v,refractionRatio:.5,roughness:0,metalness:.5}),i=_.clone(o);i.map=null;i.side=2;var u=eval("({"+"d=300,x=80,cal=0.5,l=251.3274,r=40,d1=18.75,d2=37.5,choose=3,inner=0.3,outer=0.2,inx=80,ind=300".replace(/=/ig,":")+"})"),y=u.d,s=u.d1,h=u.d2,n=u.r,c=y-s,f=0,r=this.genParametricGeometry({fx:"cos(u) * sin(v)*"+n,fy:"(sin(u) * cos(v) + cos(v))*"+n,fz:c*2/Math.PI+"*u",rangeU:[0,Math.PI*.5],rangeV:[0,Math.PI*2],slices:4,stacks:40}),p=this.genParametricGeometry({fx:"1.01*cos(v)*"+n,fy:"1.01*sin(v)*"+n,fz:"u",rangeU:[-f,-f-h],rangeV:[0,Math.PI*2],slices:1,stacks:40}),l=new THREE.CircleGeometry(1.01*n,40);l.translate(0,0,-f-h);var a=c,w=this.genParametricGeometry({fx:"0",fy:"u",fz:"v",rangeU:[-2*n,2*n],rangeV:[a,a+s],slices:1,stacks:1}),e=new THREE.Matrix4;r.merge(w,e,1);r.merge(p,e,2);r.merge(l,e,3);r.center();t=window.me=new THREE.Mesh(r,[o,i,i,i]);t.name="me.mesh";t.rotation.x=-Math.PI/2;t.rotation.z=-Math.PI/2;D3.scene.add(t)};this.setAngle=function(n,t,i){var u=i||r.object.position.distanceTo(r.target),f=new THREE.Spherical(u,n,t),e=(new THREE.Vector3).setFromSpherical(f);r.object.position.copy(e)};this.autoRotateUpDown=function(){var u=Math.PI,n=r.object,t=new THREE.Spherical,i;t.setFromVector3(n.position);i=window.D3;i&&(i.beforeAnimate=function(){var i=t.phi+.01;i>=2*u&&(i=-u*2);t.phi=i;n.position.setFromSpherical(t);n.up.x=0;n.up.z=0;n.up.y=n.position.z>=0?1:-1;n.lookAt(r.target)})};this.autoRotateLeftRight=function(){var u=Math.PI,t=r.object,n=new THREE.Spherical,i;n.setFromVector3(t.position);i=window.D3;i&&(i.beforeAnimate=function(){var i=n.theta+.01;i>=2*u&&(i=-u*2);n.theta=i;t.position.setFromSpherical(n);t.lookAt(r.target)})};this.addPlaneTag=function(n){var t=D3.$planeTag;if(!t){t=new THREE.Group;n||r.object.layers.disable(4);t.$funs=[];var u=D3.curModel.mesh,f=this.target,i,e=this;D3.scene.traverse(function(n){if(n.name&&n.name.indexOf(".mesh")!==-1){var o=n.name.substr(0,n.name.indexOf(".")),r=new SpriteText(o);r.layers.set(4);r.color="#0000FF";r.$plane=n;r.$defaultScale=r.scale.clone();t.add(r);r.name=o;i=function(){var h=(new THREE.Box3).setFromObject(n.obj),t=h.min.clone().add(h.max).multiplyScalar(.5),o,s;return t.add(u.position),D3.control.fold<=.01?t.z=10:ut(t,f,10),r.position.set(0,0,0).add(t),o=(r.position.distanceTo(e.object.position)||1)/670,s=r.$defaultScale,r.scale.set(o*s.x,o*s.y,1),i};t.$funs.push(i())}});D3.scene.add(t);D3.$planeTag=t;D3.beforeAnimate=function(){_.forEach(t.$funs,function(n){n()})}}};this.focusTo=function(n){if(_.isString(n)&&(n=this.findSprite(n)),n){this.selectSprite(n);D3.vue.resetView();var i=this.target,t=n.position.clone();return D3.control.fold<=.01?(r.object.position.setScalar(0).add(t).add(new THREE.Vector3(0,0,200)),i.add(t)):(t.sub(i).normalize(),t.multiplyScalar(350).add(i),r.object.position.set(0,0,0).add(t)),n}};this.findSprite=function(n){var i,t,r;for(this.addPlaneTag(),i=D3.$planeTag,t=0;t<i.children.length;t++)if(r=i.children[t],r.name==n)return r;return null};this.selectSprite=function(n){var i=n,t=D3.$cacheFocusTo;if(t&&(t.sprite.color="#0000FF",_.set(t.sprite,"$plane.mats[0]",t.defaultMaterialA),_.set(t.sprite,"$plane.mats[1]",t.defaultMaterialB)),_.isString(n)&&(n=this.findSprite(n)),!n){console.log("找不到面: ",i);return}return D3.$cacheFocusTo={sprite:n,defaultMaterialA:_.get(n,"$plane.mats[0]"),defaultMaterialB:_.get(n,"$plane.mats[1]")},n.color="#FF0000",_.set(n,"$plane.mats[0]",new THREE.MeshPhongMaterial({color:"#88FF88",side:0,transparent:!0,opacity:D3.control.isPerspectiveMode?.5:1})),_.set(n,"$plane.mats[1]",new THREE.MeshPhongMaterial({color:"#88FF88",side:1,transparent:!0,opacity:D3.control.isPerspectiveMode?.5:1})),n};this.outputGltf=function(n,t){var i=function(){let n=t||D3.curModel.mesh,i=new THREE.GLTFExporter;var u=eval("({"+_.replace(D3.curData.boxPms,/=/ig,":")+"})"),r={animations:n.animations||[]};i.parse(n,function(n){_.forEach(n.animations,function(t){var i=_.findIndex(n.nodes,function(n){return n.name==t.name});i>=0&&_.set(t,"channels[0].target.node",i)});_.extend(n.asset,{generator:"Packmage"});let t=document.createElement("a");t.style.display="none";document.body.appendChild(t);t.href=URL.createObjectURL(new Blob([JSON.stringify(n)],{type:"text/plain"}));t.download=D3.curData.boxID+".gltf";t.click();document.body.removeChild(t)},r)};n?i():D3.changeImageA("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAFElEQVQYV2P8////fwYGBgZGGAMAV9UH+8N+dSUAAAAASUVORK5CYII=",0,function(){D3.changeImageB("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAFElEQVQYV2P8////fwYGBgZGGAMAV9UH+8N+dSUAAAAASUVORK5CYII=",0,i)})};this.importGltf=function(n,t){const i=new THREE.GLTFLoader;i.load(n,function(n){var i=n.scene.children[0];D3.scene.add(i);t&&t(i)},function(n){console.log(n.loaded/n.total*100+"% loaded");n.loaded/n.total*100==100&&console.log(n.loaded/n.total*100+"% loaded")},function(n){console.log("load error!",n)})};k=0;g=null;this.bindMouseMove=function(){var o,i,t;D3.autoCenter=!1;D3.__setCenter();o=new THREE.OctahedronGeometry(5);i=new THREE.Mesh(o,new THREE.MeshNormalMaterial);D3.scene.add(i);t=[];D3.scene.traverse(function(n){_.endsWith(n.name,".mesh")&&t.push(n)});g=t;var e=new THREE.Raycaster,n=new THREE.Vector2,s=r.object,h=function(o){n.x=o.clientX/r.domElement.clientWidth*2-1;n.y=-(o.clientY/r.domElement.clientHeight)*2+1;e.setFromCamera(n,s);var h=e.intersectObjects(t);h.length>0&&(i.position.set(0,0,0),i.position.copy(h[0].point),console.warn(h[0].face.materialIndex,"materialIndex"),k&&(f=u.NONE,v=u.NONE,D3.__control.drawMaterialCache(h[0])))},c=function(i){n.x=i.clientX/r.domElement.clientWidth*2-1;n.y=-(i.clientY/r.domElement.clientHeight)*2+1;e.setFromCamera(n,s);var o=e.intersectObjects(t);o.length>0&&(console.log(o[0]),k=1,Math.abs(o[0].uv.x-.5)<=.05&&Math.abs(o[0].uv.y-.5)<=.05,D3.__control.drawMaterialCache(o[0]),f=u.NONE,v=u.NONE,r.enabled=!1,r.domElement.removeEventListener("mousemove",nt),r.removeEventListener("mouseup",d))},l=function(){k=0;f=u.NONE;v=u.NONE;r.enabled=!0};r.domElement.addEventListener("mousemove",h,!1);r.domElement.addEventListener("mousedown",c,!1);r.domElement.addEventListener("mouseup",l,!1)};this.genMaterialCache=function(n){D3.$cache=D3.$cache||{};var t=function(n){var i=D3.curModel.mesh.mats[n].map.image,t=document.createElement("CANVAS"),r;return t.width=i.width,t.height=i.height,r=t.getContext("2d"),r.drawImage(i,0,0),t};return D3.$cache.cvs=[t(0),t(1)],D3.$cache.cvs[n||0]};this.drawMaterialCache=function(n){var f=n.uv,t=n.face.materialIndex,i;if(!(t>=2)){i=_.get(D3,"$cache.cvs["+t+"]");i||(i=r.genMaterialCache(t));var e=D3.curModel.mesh.mats[t].map.image,u=e.getContext("2d"),o=60;u.drawImage(i,0,0);f&&(u.beginPath(),o=Math.max(i.width,i.height)*.05,u.arc(e.width*f.x,e.height*(1-f.y),o,0,2*Math.PI),u.fillStyle="rgba(255, 88, 88, 0.5)",u.fill());D3.curModel.mesh.mats[t].map.needsUpdate=!0;_.forEach(g,function(n){n.material.length&&n.material.length>t?n.material[t].map.needsUpdate=!0:n.material.map.needsUpdate=!0})}};this.backgroundShader=function(){var n=new THREE.ShaderMaterial({wireframe:!1,transparent:!1,uniforms:{tBackground:{type:"t",value:null}},vertexShader:"#define GLSLIFY 1\nvarying vec2 vUv;\n\nvoid main()\n{\n    vUv = uv;\n\n    vec3 newPosition = position;\n    newPosition.z = 1.0;\n    gl_Position = vec4(newPosition, 1.0);\n}\n",fragmentShader:"#define GLSLIFY 1\nuniform sampler2D tBackground;\n\nvarying vec2 vUv;\n\nvoid main()\n{\n    vec4 backgroundColor = texture2D(tBackground, vUv);\n\n    gl_FragColor = backgroundColor;\n}\n"})};this.autoRotateCamera=function(){var t=Date.now(),n=0;(!r.time||(n=(t-r.time)*.00025*.5*Math.PI),r.time=t,n&&f!=u.ROTATE&&f!=u.TOUCH_ROTATE)&&(n*=r.rotateSpeed,D3.curModel.mesh.rotation[this.autoRotateAxis]+=n)};this.autoRotateCamera0=function(){var e=Date.now(),n=0,i,t;if(!r.time||(n=(e-r.time)*.00025*.5*Math.PI),r.time=e,n&&f!=u.ROTATE&&f!=u.TOUCH_ROTATE)for(i=new THREE.Vector3(0,1,0),i=r.object.up,quaternion=new THREE.Quaternion,n*=r.rotateSpeed,quaternion.setFromAxisAngle(i,-n),r.object.position.applyQuaternion(quaternion),t=0;t<r.lights.length;t++)r.lights[t].position.applyQuaternion(quaternion)};this.zoomCamera=function(){var n;f===u.TOUCH_ZOOM?(n=b/p,b=p,e.multiplyScalar(n)):(n=1+(y.y-l.y)*r.zoomSpeed,n!==1&&n>0&&(e.multiplyScalar(n),r.staticMoving?l.copy(y):l.y+=(y.y-l.y)*this.dynamicDampingFactor))};this.panCamera=function(n,t){var i,u;n||(n=r.panSpeed);t||(t=r.staticMoving);i=o.clone().sub(h);i.lengthSq()&&(i.multiplyScalar(e.length()*n),u=e.clone().cross(r.object.up).setLength(i.x),u.add(r.object.up.clone().setLength(i.y)),r.object.position.add(u),r.target.add(u),t?h=o:h.add(i.subVectors(o,h).multiplyScalar(r.dynamicDampingFactor)))};this.checkDistances=function(){r.noZoom&&r.noPan||(r.object.position.lengthSq()>r.maxDistance*r.maxDistance&&r.object.position.setLength(r.maxDistance),e.lengthSq()<r.minDistance*r.minDistance&&r.object.position.addVectors(r.target,e.setLength(r.minDistance)))};this.update=function(){(r.autoRotate&&this.autoRotateCamera(),r.isControls)&&(e.subVectors(r.object.position,r.target),r.noRotate||r.rotateCamera(),r.noZoom||r.zoomCamera(),r.noPan||r.panCamera(),r.object.position.addVectors(r.target,e),r.checkDistances(),r.object.lookAt(r.target),a.distanceToSquared(r.object.position)>0&&(r.dispatchEvent(w),a.copy(r.object.position)))};this.reset=function(){f=u.NONE;v=u.NONE;r.target.copy(r.target0);r.object.position.copy(r.position0);r.object.up.copy(r.up0);e.subVectors(r.object.position,r.target);r.object.lookAt(r.target);r.dispatchEvent(w);a.copy(r.object.position)};this.domElement.addEventListener("contextmenu",function(n){n.preventDefault()},!1);this.domElement.addEventListener("mousedown",ft,!1);this.domElement.addEventListener("mouseup",d,!1);this.domElement.addEventListener("mousewheel",it,!1);this.domElement.addEventListener("DOMMouseScroll",it,!1);this.domElement.addEventListener("touchstart",et,!1);this.domElement.addEventListener("touchend",st,!1);this.domElement.addEventListener("touchmove",ot,!1);this.handleResize();this.object.__linRotate=function(n,t,i){t=t*Math.PI/180;i||(r.target.copy(r.target0),r.object.position.copy(r.position0),r.object.up.copy(r.up0),e.subVectors(r.object.position,r.target),r.object.lookAt(r.target),r.dispatchEvent(w),a.copy(r.object.position));quaternion=new THREE.Quaternion;quaternion.setFromAxisAngle(n,-t);e.applyQuaternion(quaternion);r.object.up.applyQuaternion(quaternion);r.object.position.addVectors(r.target,e);r.checkDistances();r.object.lookAt(r.target);a.distanceToSquared(r.object.position)>0&&(r.dispatchEvent(w),a.copy(r.object.position))};this.object.__linZoom=function(n){l.y+=n*.01};this.object.__linPan=function(n,t){n/=1e3;t/=1e3;h=r.getMouseOnScreen(0,0);o=r.getMouseOnScreen(0,0);o.x+=n;o.y+=t;r.panCamera(1,1)}};THREE.TrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype);