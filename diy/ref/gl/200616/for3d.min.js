var Zw;!function(){function s(t){var u=f[t%f.length],i=n.factoryOfTextureAB.contextCal;u.color?(i.fillStyle=u.color,i.fillRect(0,0,i.canvas.width,i.canvas.height)):i.drawImage(r,0,u.start,r.width,u.end-u.start,0,0,i.canvas.width,i.canvas.height)}function l(t){var i=n.factoryOfTextureAB.contextCal,u;t.color?(i.fillStyle=t.color,i.fillRect(0,0,i.canvas.width,i.canvas.height)):(u=_.find(f,function(n){return n.name==t.name}),i.drawImage(r,0,u.start,r.width,u.end-u.start,0,0,i.canvas.width,i.canvas.height))}function t(n,t,i){if(n){var r=0,u=0;return u=n.z<=0?1:0,r=(i?n.y:n.x)/t*.3,new THREE.Vector2(r,u)}}function u(n,t){return new THREE.MeshStandardMaterial({side:t,map:n,refractionRatio:.5,roughness:.9,metalness:.5})}function a(t,i,r){for(var p,l,a,d,o,g=n.LoadCanvasTexture(n.factoryOfTextureAB.canvasA,null,null,1),ut=new THREE.MeshStandardMaterial({side:0,color:"#FFF",map:g,refractionRatio:.5,roughness:0,metalness:.5}),y=eval("({"+t.replace(/=/ig,":")+"})"),ft=y.d,nt=y.d1,tt=y.d2,h=y.r,w=v,it=ft-nt,c=w({fz:"cos(u) * sin(v)*"+h,fx:"(sin(u) * cos(v) + cos(v))*"+h,fy:it*2/Math.PI+"*u",rangeU:[0,Math.PI*.5],rangeV:[0,Math.PI*2],slices:4,stacks:40}),s=_.find(i,{name:"M0"}),u=c.faceVertexUvs[0],e=function(n,t){u[n][t].x+=u[n][t].y;u[n][t].y=u[n][t].x-u[n][t].y;u[n][t].x=u[n][t].x-u[n][t].y;u[n][t].x=1-u[n][t].x;u[n][t].y=1-THREE.Math.mapLinear(u[n][t].y,0,1,(s.border[3]-r.Top)/r.BoxH,(s.border[1]-r.Top)/r.BoxH)},f=0;f<u.length;f++)e(f,0),e(f,1),e(f,2);for(p=w({fz:"1.01*cos(v)*"+h,fx:"1.01*sin(v)*"+h,fy:"u",rangeU:[0,-tt],rangeV:[-Math.PI/2,Math.PI*1.5],slices:1,stacks:40}),p.rotateY(Math.PI),s=_.find(i,{name:"M2"}),u=p.faceVertexUvs[0],e=function(n,t){u[n][t].x+=u[n][t].y;u[n][t].y=u[n][t].x-u[n][t].y;u[n][t].x=u[n][t].x-u[n][t].y;u[n][t].y=1-THREE.Math.mapLinear(u[n][t].y,0,1,(s.border[1]-r.Top)/r.BoxH,(s.border[3]-r.Top)/r.BoxH)},f=0;f<u.length;f++)e(f,0),e(f,1),e(f,2);for(l=new THREE.CircleGeometry(1.01*h,40),s=_.find(i,{name:"M3"}),u=l.faceVertexUvs[0],e=function(n,t){u[n][t].x=1-THREE.Math.mapLinear(u[n][t].x,0,1,(s.border[2]-r.Left)/r.BoxW,(s.border[0]-r.Left)/r.BoxW);u[n][t].y=1-THREE.Math.mapLinear(u[n][t].y,0,1,(s.border[3]-r.Top)/r.BoxH,(s.border[1]-r.Top)/r.BoxH)},f=0;f<u.length;f++)e(f,0),e(f,1),e(f,2);l.rotateX(Math.PI/2);l.translate(0,-tt,0);var rt=it,b=w({fz:"0",fx:"u",fy:"v",rangeU:[-2*h,2*h],rangeV:[rt,rt+nt],slices:1,stacks:1}),k=b.clone();for(s=_.find(i,{name:"M1"}),u=b.faceVertexUvs[0],e=function(n,t){u[n][t].x=.5+.5*u[n][t].x;u[n][t].y=1-THREE.Math.mapLinear(u[n][t].y,0,1,(s.border[3]-r.Top)/r.BoxH,(s.border[1]-r.Top)/r.BoxH)},f=0;f<u.length;f++)e(f,0),e(f,1),e(f,2);for(k.rotateY(Math.PI),u=k.faceVertexUvs[0],e=function(n,t){u[n][t].x=.5*u[n][t].x;u[n][t].y=1-THREE.Math.mapLinear(u[n][t].y,0,1,(s.border[3]-r.Top)/r.BoxH,(s.border[1]-r.Top)/r.BoxH)},f=0;f<u.length;f++)e(f,0),e(f,1),e(f,2);return a=new THREE.Matrix4,c.merge(b,a,0),c.merge(k,a,0),c.merge(p,a,0),c.merge(l,a,0),c.center(),d=[ut],o=window.me=new THREE.Mesh(c,d),o.name="me.mesh",o.mats=d,o.maps=[g],o.doFold=o.doExpond=o.doReset=o.doFoldOrExpond=o.doChange=o.autoFold=o.getPercent=o.setPercent=o.moveToOrg=o.changeCalUvByGrain=o.changeCalTextureByIdx=o.changeCalTexture=function(){},o.obj=o,o}function v(n){n=_.extend({fx:"cos(u) * sin(v)",fy:"sin(u) * cos(v) + cos(v)",fz:"u * 6",rangeU:[0,Math.PI*.5],rangeV:[0,Math.PI*2],slices:4,stacks:40},n);var t=Parser.parse(n.fx).toJSFunction(["u","v"]),i=Parser.parse(n.fy).toJSFunction(["u","v"]),r=Parser.parse(n.fz).toJSFunction(["u","v"]),u=function(u,f,e){u=THREE.Math.mapLinear(u,0,1,n.rangeU[0],n.rangeU[1]);f=THREE.Math.mapLinear(f,0,1,n.rangeV[0],n.rangeV[1]);var o=t(u,f),s=i(u,f),h=r(u,f);isNaN(o)||isNaN(s)||isNaN(h)?e.set(0,0,0):e.set(o,s,h)};return new THREE.ParametricGeometry(u,n.slices,n.stacks)}function i(n,t,i){return i?new THREE.Vector2(1-(n.x-t.Left)/t.BoxW,1-(-n.y-t.Top)/t.BoxH):new THREE.Vector2((n.x-t.Left)/t.BoxW,1-(-n.y-t.Top)/t.BoxH)}function h(n,t,r,u){for(var e=t.faces,f=0;f<e.length;f++)e[f].materialIndex=0,n.push([i(t.vertices[e[f].a],r,u),i(t.vertices[e[f].b],r,u),i(t.vertices[e[f].c],r,u)])}var n=Zw={Vesion:"2.0.6"},o=6,e=0,f=[{start:0,end:52,name:"wa3"},{start:52,end:140,name:"wa5"},{start:140,end:272,name:"wa7"},{start:272,end:344,name:"feng"},],c=[52,88,132,72,84,84],r;n.factoryOfTextureAB=function(){var s=0,u=document.createElement("canvas"),f=document.createElement("canvas"),e=document.createElement("canvas"),t=u.getContext("2d"),i=f.getContext("2d"),r=e.getContext("2d"),o;return u.width=u.height=f.width=f.height=2,e.width=256,e.height=128,t.fillStyle=i.fillStyle=r.fillStyle="white",t.fillRect(0,0,t.canvas.width,t.canvas.height),i.fillRect(0,0,i.canvas.width,i.canvas.height),r.fillRect(0,0,r.canvas.width,r.canvas.height),o=function(t,i){var r=i/Math.max(n.BoxW,n.BoxH);t.canvas.width=Math.floor(r*n.BoxW);t.canvas.height=Math.floor(r*n.BoxH);t.fillStyle="white";t.fillRect(0,0,t.canvas.width,t.canvas.height)},{get isRendering(){return s},set isRendering(n){s=n},maxSize:2048,setCanvasSize:function(){o(this.contextA,this.maxSize);this.isDoubleTexture&&o(this.contextB,this.maxSize)},isDoubleTexture:0,canvasA:u,canvasB:f,canvasCal:e,contextA:t,contextB:i,contextCal:r}}();r=document.createElement("IMG");r.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAFYCAMAAACLcdLOAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTExIDc5LjE1ODMyNSwgMjAxNS8wOS8xMC0wMToxMDoyMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6QkE3OEFDNjBCRTc3MTFFQThGQUJEMkNENEM1RDhBN0QiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6QkE3OEFDNUZCRTc3MTFFQThGQUJEMkNENEM1RDhBN0QiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKFdpbmRvd3MpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QTkwOUM1RUVCRDA1MTFFQUJFNThEMENDMzY4RDFFNzMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QTkwOUM1RUZCRDA1MTFFQUJFNThEMENDMzY4RDFFNzMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5RfjUWAAAAwFBMVEVmUD1y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";r.onload=function(){s(o)};n.getCalTextureList=function(){return _.map(f,function(n){return{name:n.name,color:n.color}})};n.Zoom=1;n.MaxSize=200;n.OffsetX=0;n.OffsetY=0;n.Left=Infinity;n.Right=-Infinity;n.Top=Infinity;n.Bottom=-Infinity;n.BoxW=0;n.BoxH=0;n.MaxAngleStep=0;n.Cal=.5;n.foldDirect=1;n.opacity=.25;n.setTextureCalIndex=function(n){o=n%(c.length+1)};n.LoadTexture=function(n,t,i){var u=new THREE.LoadingManager,r=new THREE.Texture,f=new THREE.ImageLoader(u);return f.load(n,function(n){r.image=n;r.needsUpdate=!0;r.onUpdate=i;t&&t(r)}),r.minFilter=THREE.LinearFilter,r.magFilter=THREE.LinearFilter,r};n.LoadCanvasTexture=function(n,t,i){if(_.get(n,"tagName")!=="CANVAS")throw new Error("传入的必须是canvas对象！");var r=new THREE.CanvasTexture(n);r.needsUpdate=!0;r.minFilter=THREE.LinearFilter;r.magFilter=THREE.LinearFilter;r.onUpdate=i;
//!noLog && console.log('%c LoadTexture by canvas', 'color:orange');
return t&&t(r),r};n.CurrMesh=null;n.Meshes=[];n.setPlaneAlpha=function(t,i){var u,r;if(n.isNull(t.obj)||(u=i?n.opacity:1,_.forEach([0,1,2,3,4],function(n){_.get(t,"obj.material["+n+"]")&&(t.obj.material[n].transparent=!!i,t.obj.material[n].opacity=u)})),!n.isNull(t.children))for(r=0;r<t.children.length;r++)n.setPlaneAlpha(t.children[r],i)};n.loadOne=function(t){var r,h,o,u,f,i,e,c,s;if(t.ce&&n.setBoxAllOutPms(t.ce),n.setBoxBorder(t.de),r=n.generatePlanes(t.ge.b),_.forEach(t.ge.p,function(n,t){r[t].setFaces(n.a,n.b);r[t].setFoldlinesToDraw(n.d);r[t].setCutlinesToDraw(n.e);r[t].removeCutlinesInFoldlines();r[t].basePlane&&(n.c?r[t].setFoldLine(n.c[0],n.c[1],n.c[2],n.c[3],n.c[4]):r[t].setFoldLine(0,0,1,0,[0]))}),h=n.genSetting(),o=_.invoke(t,"de.BoxID.toUpperCase"),o==="U001")return i=a(t.ce,r,h),i.planes=r,i;if(o==="U002"){if(i=t._g,i.material.map.image=n.factoryOfTextureAB.canvasA,i.name="me.mesh",i.mats=[i.material],i.maps=[i.material.map],i.doFold=i.doExpond=i.doReset=i.doFoldOrExpond=i.doChange=i.autoFold=i.getPercent=i.setPercent=i.moveToOrg=i.changeCalUvByGrain=i.changeCalTextureByIdx=i.changeCalTexture=function(){},i.obj=i,!i._hasCache){for(i._hasCache=1,u=i.geometry.getAttribute("uv"),f=0;f<u.count;f++)u.array[f*6+1]=1-u.array[f*6+1],u.array[f*6+3]=1-u.array[f*6+3],u.array[f*6+5]=1-u.array[f*6+5];u.needsUpdate=!0;i.geometry.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2))}return e=eval("({"+t.ce.replace(/=/ig,":")+"})"),i.scale.set(e.l/4,e.d*.1618647,e.w*.46168),i}return o==="U003"?(i=t._g,i.material.map.image=n.factoryOfTextureAB.canvasA,i.name="me.mesh",i.mats=[i.material],i.maps=[i.material.map],i.doFold=i.doExpond=i.doReset=i.doFoldOrExpond=i.doChange=i.autoFold=i.getPercent=i.setPercent=i.moveToOrg=i.changeCalUvByGrain=i.changeCalTextureByIdx=i.changeCalTexture=function(){},i.obj=i,e=eval("({"+t.ce.replace(/=/ig,":")+"})"),i.scale.set(20,20,20),i):(c=new n.Show3D(r,h),s=c.draw(),n.addMesh(s),s.planes=r,s)};n.addMesh=function(t){n.Meshes.push(t);n.isNull(n.CurrMesh)&&(n.CurrMesh=t)};n.removeMesh=function(t){n.Meshes.pop(t)};n.DefaultError=function(n){console.log(n)};n.setBoxBorder=function(t){n.MaxAngleStep=0;n.Cal=new Function("with("+n.AllOutPms+"){return cal||0.5}")();n.OffsetX=t.OffsetX;n.OffsetY=t.OffsetY;n.BoxW=t.Width;n.BoxH=t.Height;n.Zoom=n.MaxSize/Math.max(n.BoxW,n.BoxH);n.Left=Infinity;n.Right=-Infinity;n.Top=Infinity;n.Bottom=-Infinity;n.factoryOfTextureAB.setCanvasSize()};n.genSetting=function(){return(Math.abs(Zw.Right-Zw.Left-Zw.BoxW)>=.01||Math.abs(Zw.Bottom-Zw.Top-Zw.BoxH)>=.01)&&console.warn("警告：边框计算不吻合，现以返回的点计算值为准！"),Zw.BoxW=Zw.Right-Zw.Left,Zw.BoxH=Zw.Bottom-Zw.Top,_.pick(n,"Cal","Zoom","MaxSize","OffsetX","OffsetY","Left","Right","Top","Bottom","BoxW","BoxH","MaxAngleStep")};n.setBoxAllOutPms=function(t){n.AllOutPms="{ "+t.replace(/=/ig,": ")+", pi: Math.PI }"};n.isNull=function(n){return typeof n=="undefined"||n==null};n.generatePlanes=function(t){var u=[],i={},r;return _.forEach(t,function(t){t.indexOf(":")!=-1&&(t=t.substr(0,t.indexOf(":")));var r=new n.Plane(t);u.push(r);i[t]=r}),r=null,_.forEach(t,function(t){var u,f,e,o;if(!r)return r=t,!0;t.indexOf(":")==-1&&(t+=":"+r);u=t.substr(0,t.indexOf(":"));f=t.substr(t.indexOf(":")+1);n.isNull(i[u])||n.isNull(i[f])||(e=i[u],o=i[f],e.setBasePlane(o))}),u};n.Plane=function(){arguments.length>=1&&(this.name=arguments[0]);arguments.length>=2&&(this.foldLine=arguments[1]);this.group=new THREE.Group;this.group.name=this.name+".group"};n.Plane.prototype={constructor:n.Plane,setFaces:function(t,i){if(t&&t.length){var r=this.border=[Infinity,Infinity,-Infinity,-Infinity];this.content=t;this.cover=i;_.forEach(t,function(t){for(var i=0;i<t.length;i+=2)r[0]>t[i]&&(r[0]=t[i]),r[1]>t[i+1]&&(r[1]=t[i+1]),r[2]<t[i]&&(r[2]=t[i]),r[3]<t[i+1]&&(r[3]=t[i+1]),n.Left>t[i]&&(n.Left=t[i]),n.Top>t[i+1]&&(n.Top=t[i+1]),n.Right<t[i]&&(n.Right=t[i]),n.Bottom<t[i+1]&&(n.Bottom=t[i+1])})}},onErrorCallback:function(){n.DefaultError(this.error)},onError:function(n){return this.onErrorCallback=n,this},setGroupPostion:function(){this.hasBase()&&this.basePlane.hasBase()?!this.foldLine||!this.basePlane.foldLine||this.group.position.set(this.foldLine.from.x-this.basePlane.foldLine.from.x,this.foldLine.from.y-this.basePlane.foldLine.from.y,0):!this.foldLine||this.group.position.set(this.foldLine.from.x,this.foldLine.from.y,0)},setBasePlane:function(n){return this.basePlane=n,n.group.add(this.group),this},hasBase:function(){return!n.isNull(this.basePlane)},setFoldLine:function(){if(arguments.length==5)return arguments[4].length==0?void 0:(this.foldLine=new n.FoldLine(arguments[0],-arguments[1],arguments[2],-arguments[3],arguments[4]),n.MaxAngleStep<this.foldLine.phaseAngle.length&&(n.MaxAngleStep=this.foldLine.phaseAngle.length),this);this.error="折线的初始化数据不正确！";this.onErrorCallback();return},setCutlinesToDraw:function(n){if(n){if(n.length%2!=0){this.error="面"+this.name+"的cutlinesToDraw的长度必须是2的倍数！"+n;this.onErrorCallback();this.cutlinesToDraw=[];return}this.cutlinesToDraw=n}},setFoldlinesToDraw:function(n){if(n){if(n.length%2!=0){this.error="面"+this.name+"的foldlinesToDraw的长度必须是2的倍数！";this.onErrorCallback();return}this.foldlinesToDraw=n}},removeCutlinesInFoldlines:function(){var n=this.cutlinesToDraw,i=this.foldlinesToDraw,u,f,t,r;if(i&&i.length&&n&&n.length){for(u=[],f=!1,t=0;t<n.length;t+=4){for(f=!1,r=0;r<i.length;r+=4)if(n[t]==i[r]&&n[t+1]==i[r+1]&&n[t+2]==i[r+2]&&n[t+3]==i[r+3]||n[t]==i[r+2]&&n[t+1]==i[r+3]&&n[t+2]==i[r]&&n[t+3]==i[r+1]){f=!0;break}f||(u.push(n[t]),u.push(n[t+1]),u.push(n[t+2]),u.push(n[t+3]))}this.cutlinesToDraw=u}}};n.FoldLine=function(){if(arguments.length==3?(this.from=arguments[0],this.to=arguments[1],this.phaseAngle=arguments[2]):arguments.length==5&&(this.from=new THREE.Vector2(arguments[0],arguments[1]),this.to=new THREE.Vector2(arguments[2],arguments[3]),this.phaseAngle=arguments[4]),n.AllOutPms)for(var t=0;t<this.phaseAngle.length;t++)this.phaseAngle[t]=new Function("with("+n.AllOutPms+"){with(Math){return "+this.phaseAngle[t]+"}}")();return this};n.FoldLine.prototype={constructor:n.FoldLine,getCurrentAngle:function(n,t){if(t<this.phaseAngle.length&&(t=this.phaseAngle.length),t-=1,n<=0||this.phaseAngle.length==1)return this.phaseAngle[0];if(n>=1)return this.phaseAngle[this.phaseAngle.length-1];var r=t*n,i=Math.floor(r);return i>=this.phaseAngle.length-1?this.phaseAngle[this.phaseAngle.length-1]:this.phaseAngle[i]+(r-i)*(this.phaseAngle[i+1]-this.phaseAngle[i])},genAnimation:function(t){var e=new THREE.Vector3,i,f,u,o,r;for(e.set(this.to.x-this.from.x,this.to.y-this.from.y,0).normalize(),i=n.MaxAngleStep,f=[],u=0;u<i;u++)o=this.getCurrentAngle(u/(i-1),i,this.phaseAngle),r=(new THREE.Quaternion).setFromAxisAngle(e,THREE.Math.degToRad(o)),f.push(r.x,r.y,r.z,r.w);var s=Array.apply(null,{length:i}).map(function(n,t){return t}),h=new THREE.QuaternionKeyframeTrack(".quaternion",s,f);return new THREE.AnimationClip(t,i,[h])},toString:function(){return"("+this.from.x+","+this.from.y+") --> ("+this.to.x+","+this.to.y+")"}};n.Movie=function(n){this.runStatus=!1;this.interval=n};n.Movie.prototype={constructor:n.Movie,onErrorCallback:function(){n.DefaultError(this.error)},onError:function(n){return this.onErrorCallback=n,this},onRefrashCallback:function(){},onRefrash:function(n){return this.onRefrashCallback=n,this},setCallBack:function(n){this.__callback=n},sh:null,on:function(){this.runStatus=!0;var n=this;n.sh!=null&&clearInterval(n.sh);this.sh=setInterval(function(){try{n.onRefrashCallback();!n.__callback||n.__callback()}catch(t){n.error=t.message;n.onErrorCallback();n.runStatus=!1}n.runStatus||clearInterval(n.sh)},n.interval)},off:function(){this.runStatus=!1},doChange:function(){this.runStatus?this.runStatus=!1:this.on()}};n.Show3D=function(n,t){this.planes=n;this.percent=0;this.topMesh=null;this.animations=[];this.percentDiff=.03;this.isFold=!0;this.setting=t};n.Show3D.prototype={constructor:n.Show3D,doFold:function(){this.percent+=this.percentDiff;this.percent>1&&(this.percent=1);this.doFoldOrExpond()},doExpond:function(){this.percent-=this.percentDiff;this.percent<0&&(this.percent=0);this.doFoldOrExpond()},doFoldOrExpond:function(){for(var i,r,t=0;t<this.planes.length;t++)this.planes[t].foldLine&&(r=this.planes[t].foldLine.getCurrentAngle(this.percent,n.MaxAngleStep),i=this.planes[t].group.$foldVector,i||(i=new THREE.Vector3,i.set(this.planes[t].foldLine.to.x-this.planes[t].foldLine.from.x,this.planes[t].foldLine.to.y-this.planes[t].foldLine.from.y,0).normalize(),this.planes[t].group.$foldVector=i),this.planes[t].group.setRotationFromAxisAngle(i,n.foldDirect*r*Math.PI/180))},doReset:function(){this.percent=0;this.doFoldOrExpond();this.topMesh.position.set(0,0,0);this.topMesh.rotation.set(0,0,0)},genMaterial:function(t){return new THREE.MeshPhongMaterial({map:n.LoadCanvasTexture(n.factoryOfTextureAB.canvas,null,function(){n.__renderAB=n.__renderAB||0;n.__renderAB++},1),side:t,transparent:!0})},draw:function(){var t=this,i=n.LoadCanvasTexture(n.factoryOfTextureAB.canvasA,null,null,1),r=n.LoadCanvasTexture(n.factoryOfTextureAB.canvasB,null,null,1),e=n.LoadCanvasTexture(n.factoryOfTextureAB.canvasCal,null,null,1),h=u(i,0),c=u(r,0),a=u(i,THREE.DoubleSide),v=u(r,THREE.DoubleSide),f,o;return _.forEach(this.planes,function(n){n.setGroupPostion()}),f=[h,c,a,v],o=[i,r,e],_.forEach(this.planes,function(n){t.drawOnePlane(n,f,e)}),this.topMesh.mats=f,this.topMesh.maps=o,this.topMesh.doFold=function(){t.doFold()},this.topMesh.doExpond=function(){t.doExpond()},this.topMesh.doReset=function(){t.doReset()},this.topMesh.doFoldOrExpond=function(){t.doFoldOrExpond()},this.topMesh.doChange=function(){t.doChange()},this.topMesh.autoFold=function(){(t.percent>=1||t.percent<=0)&&(t.isFold=!t.isFold);t.isFold?t.doFold():t.doExpond()},this.topMesh.getPercent=function(){return t.percent},this.topMesh.setPercent=function(n){return t.percent=n,t.topMesh},this.topMesh.moveToOrg=function(){this.position.set(this.setting.OffsetX,-this.setting.OffsetY,0)},this.topMesh.changeCalUvByGrain=function(n){_.forEach(this.planes,function(t){t.changeCalUvByGrain&&t.changeCalUvByGrain(n)})},this.topMesh.changeCalTextureByIdx=function(n){s(n);t.topMesh.maps[2].needsUpdate=!0},this.topMesh.changeCalTexture=function(n){l(n);t.topMesh.maps[2].needsUpdate=!0},this.topMesh.setting=t.setting,this.topMesh},drawOnePlane:function(r,f,o){var b,ot,a,d,ht,l,c,pt,ct,v,y,g,ft,w,et,s,ut;if(r.hasBase()||(this.topMesh?console.error("注意：盒型结构不合理，同时存在两个根面！"):(this.topMesh=r.group,this.topMesh.animations=this.animations,this.topMesh.position.set(n.OffsetX,-n.OffsetY,0))),b=_.get(r,"foldLine"),b&&(ot=new THREE.Vector3,ot.set(b.to.x-b.from.x,b.to.y-b.from.y,0).normalize(),this.animations.push(b.genAnimation(r.group.name))),r.content&&r.content.length!==0){var p=[],rt=new THREE.ShapePath,st=function(n,t){_.forEach(n,function(n){var u=new THREE.Path,r,i;for(u.moveTo(n[0],-n[1]),i=2;i<n.length;i+=2)u.lineTo(n[i],-n[i+1]);for(r=u.getPoints(),(!t&&!THREE.ShapeUtils.isClockWise(r)||t&&THREE.ShapeUtils.isClockWise(r))&&(r=_.reverse(r)),rt.moveTo(r[0].x,r[0].y),i=1;i<r.length;i++)rt.lineTo(r[i].x,r[i].y)})};st(r.content);st(r.cover,1);rt.currentPath.autoClose=!0;a=new THREE.ShapeGeometry(rt.toShapes());h(p,a,this.setting,0);var lt=f[0],at=f[1],vt=f[2],yt=f[3],nt=0,tt=[lt,at];for(a.translate(0,0,this.setting.Cal/2),d=new THREE.Geometry,d.vertices=_.cloneDeep(a.vertices),d.faces=[],s=0,ht=a.faces.length;s<ht;s++)d.faces.push(new THREE.Face3(a.faces[s].b,a.faces[s].a,a.faces[s].c));if(h(p,d,this.setting,1),a.merge(d,(new THREE.Matrix4).makeTranslation(0,0,-this.setting.Cal),++nt),l=r.foldlinesToDraw,l){for(c=new THREE.Geometry,s=0;s<l.length;s+=4)c.vertices.push(new THREE.Vector3(l[s],-l[s+1],0)),c.vertices.push(new THREE.Vector3(l[s],-l[s+1],this.setting.Cal/2)),c.vertices.push(new THREE.Vector3(l[s+2],-l[s+3],this.setting.Cal/2)),c.vertices.push(new THREE.Vector3(l[s+2],-l[s+3],0)),c.faces.push(new THREE.Face3(s,s+1,s+2)),c.faces.push(new THREE.Face3(s,s+2,s+3));for(a.merge(c,new THREE.Matrix4,++nt),a.merge(c,(new THREE.Matrix4).makeTranslation(0,0,-this.setting.Cal/2),++nt),tt.push(vt),tt.push(yt),pt=!r.foldLine?new THREE.Vector3(0,0,0):new THREE.Vector3(r.foldLine.from.x,r.foldLine.from.y,0),s=0;s<c.faces.length;s++)p.push([i(c.vertices[c.faces[s].a],this.setting),i(c.vertices[c.faces[s].b],this.setting),i(c.vertices[c.faces[s].c],this.setting)]);for(s=0;s<c.faces.length;s++)p.push([i(c.vertices[c.faces[s].a],this.setting,1),i(c.vertices[c.faces[s].b],this.setting,1),i(c.vertices[c.faces[s].c],this.setting,1)])}if(r.cutlinesToDraw.length)for(l=r.cutlinesToDraw,nt++,ct=u(o,2),o.wrapS=o.wrapT=THREE.RepeatWrapping,tt.push(ct),r.uvCal={start:p.length,count:0,cw:[],ccw:[]},s=0;s<l.length;s+=4)v=new THREE.Geometry,v.vertices.push(new THREE.Vector3(l[s],-l[s+1],-this.setting.Cal/2)),v.vertices.push(new THREE.Vector3(l[s],-l[s+1],this.setting.Cal/2)),v.vertices.push(new THREE.Vector3(l[s+2],-l[s+3],this.setting.Cal/2)),v.vertices.push(new THREE.Vector3(l[s+2],-l[s+3],-this.setting.Cal/2)),v.faces.push(new THREE.Face3(0,1,2)),v.faces.push(new THREE.Face3(0,2,3)),y=this,_.forEach(v.faces,function(n){r.uvCal.count++;r.uvCal.cw.push([t(v.vertices[n.a],y.setting.Cal,0),t(v.vertices[n.b],y.setting.Cal,0),t(v.vertices[n.c],y.setting.Cal,0)]);r.uvCal.ccw.push([t(v.vertices[n.a],y.setting.Cal,1),t(v.vertices[n.b],y.setting.Cal,1),t(v.vertices[n.c],y.setting.Cal,1)]);p.push([t(v.vertices[n.a],y.setting.Cal,e),t(v.vertices[n.b],y.setting.Cal,e),t(v.vertices[n.c],y.setting.Cal,e)])}),a.merge(v,new THREE.Matrix4,nt);if(!r.foldLine||a.translate(-r.foldLine.from.x,-r.foldLine.from.y,0),a.faceVertexUvs[0]=p,a.computeFaceNormals(),ft=1,ft?(w=(new THREE.BufferGeometry).fromGeometry(a),w.name=r.name+"_AB",g=new THREE.Mesh(w,tt)):g=new THREE.Mesh(a,tt),ft){var wt=w.getAttribute("normal"),it=wt.clone(),k=new THREE.Vector3;for(s=0,ut=it.count;s<ut;s++)k.fromArray(it.array,s*3),k.x===0&&k.y===0&&k.z===0?k.setX(1):k.normalize(),k.toArray(it.array,s*3);for(it.normalized=!0,w.setAttribute("normal",it),et=[],s=0,ut=w.attributes.position.count;s<ut;s++)et[s]=s;w.setIndex(et);r.uvCal&&(r.changeCalUvByGrain=function(n){for(var u,i=w.getAttribute("uv"),t=0;t<r.uvCal.count;t++)u=n?r.uvCal.ccw[t]:r.uvCal.cw[t],i.array[(t+r.uvCal.start)*6]=u[0].x,i.array[(t+r.uvCal.start)*6+2]=u[1].x,i.array[(t+r.uvCal.start)*6+4]=u[2].x;i.needsUpdate=!0})}else r.uvCal&&(r.changeCalUvByGrain=function(n){for(var i,u=p,t=0;t<r.uvCal.count;t++)i=n?r.uvCal.ccw[t]:r.uvCal.cw[t],u[t+r.uvCal.start][0].x=i[0].x,u[t+r.uvCal.start][1].x=i[1].x,u[t+r.uvCal.start][2].x=i[2].x;a.uvsNeedUpdate=!0});g.name=r.name+".mesh";g.userData={uvMin:{x:+THREE.Math.mapLinear(r.border[0],this.setting.Left,this.setting.Right,0,1).toFixed(5),y:+(1-THREE.Math.mapLinear(r.border[3],this.setting.Top,this.setting.Bottom,0,1)).toFixed(5)},uvMax:{x:+THREE.Math.mapLinear(r.border[2],this.setting.Left,this.setting.Right,0,1).toFixed(5),y:+(1-THREE.Math.mapLinear(r.border[1],this.setting.Top,this.setting.Bottom,0,1)).toFixed(5)}};r.group.add(g);r.group.obj=g}}}}();